---
title: "Reanalysis of Yanagihara et al 2024"
date: '`r format(Sys.time(), "%Y-%m-%d", tz = "UTC")`'
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(envirotox)
library(ssdtools)

top_model <- function(x) {
  x |>
    dplyr::group_by(Chemical) |>
    dplyr::arrange(desc(wt)) |>
    dplyr::slice(1) |>
    dplyr::ungroup() |>
    dplyr::count(dist) |>
    dplyr::arrange(desc(n))
}

wt_model <- function(x) {
  x |>
    dplyr::group_by(dist) |>
    dplyr::summarise(wt = mean(wt), .groups = "drop") |>
    dplyr::arrange(desc(wt))
}

has_burrIII3 <- function(x) {
  hasName(x, "burrIII3")
}
```

```{r acute_custom_filtered}
dists <- c("lnorm", "llogis", "burrIII3", "weibull")

data <- envirotox::yanagihara_24_acute |>
  dplyr::filter(BC <= 0.555) |>
  dplyr::nest_by(Chemical) |>
  dplyr::mutate(ssd_fit = list(ssd_fit_dists(data, dists = dists, at_boundary_ok = FALSE, computable = TRUE, silent = TRUE)),
                ssd_hc = list(ssd_hc(ssd_fit, average = FALSE))) |>
  dplyr::filter(has_burrIII3(ssd_fit)) |>
  tidyr::unnest(ssd_hc)

data |> 
  top_model() |>
  print()

data |>
  wt_model() |>
  print()
```

```{r acute_default_filtered}

data <- envirotox::yanagihara_24_acute |>
  dplyr::filter(BC <= 0.555) |>
  dplyr::nest_by(Chemical) |>
  dplyr::mutate(ssd_fit = list(ssd_fit_dists(data, silent = TRUE)),
                ssd_hc = list(ssd_hc(ssd_fit, average = FALSE))) |>
  tidyr::unnest(ssd_hc)

data |> 
  top_model() |>
  print()

data |>
  wt_model() |>
  print()
```

```{r acute_default}

data <- envirotox::yanagihara_24_acute |>
  dplyr::nest_by(Chemical) |>
  dplyr::mutate(ssd_fit = list(ssd_fit_dists(data, silent = TRUE)),
                ssd_hc = list(ssd_hc(ssd_fit, average = FALSE))) |>
  tidyr::unnest(ssd_hc)

data |> 
  top_model() |>
  print()

data |>
  wt_model() |>
  print()
```

